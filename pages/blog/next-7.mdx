import withPost from '../../components/blog/with-post'
import Image from '../../components/image'

export const meta = {
  title: 'Next.js 7',
  description: '',
  date: '2018-04-27T02:09:35.275Z',
  url: 'https://nextjs.org/blog/next-7',
  link: '/blog/next-7',
  authors: [{
    name: 'Tim Neutkens',
    avatar: '/static/team/tim.jpg',
    twitter: 'timneutkens'
  }]
}

export default withPost({...meta})

We are proud today to introduce the production-ready **Next.js 7**, featuring:

- Webpack 4
- Babel 7
- Dynamic imports improvements
- Development improvements
- Improved CDN support
- Smaller initial HTML

In addition to the Next.js 7 release, we're excited to announce the new nextjs.org.

## Webpack 4

Since it's very first release Next.js has been powered by webpack for bundling. We're excited to announce Next.js is now powered by webpack 4, the latest version of webpack.

Webpack 4 opens up a lot of new possiblities, for example Next.js now supports EcmaScript modules (`.mjs` files), code splitting and tree shaking (removal of unused code) has been improved.

Another new feature is WebAssembly support, Next.js can even server-render WebAssembly, here's an [example](https://github.com/zeit/next.js/tree/canary/examples/with-webassembly).

There are no breaking changes in Next.js related to webpack 4, but if you're adding custom webpack loaders or plugins in `next.config.js` you will have to upgrade them.

### CSS imports

With webpack 4, a new way of extracting CSS from bundles was introduced, called [mini-extract-css-plugin](https://github.com/webpack-contrib/mini-css-extract-plugin).

[`@zeit/next-css`](https://github.com/zeit/next-plugins/tree/master/packages/next-css), [`@zeit/next-less`](https://github.com/zeit/next-plugins/tree/master/packages/next-less), [`@zeit/next-sass`](https://github.com/zeit/next-plugins/tree/master/packages/next-sass), and [`@zeit/next-stylus`](https://github.com/zeit/next-plugins/tree/master/packages/next-stylus) are now powered by `mini-extract-css-plugin`.

The new version of these Next.js plugins solves 20 existing issues related to CSS imports, one example is that importing CSS in dynamic `import()`s is now supported.

A major improvement is that you're no longer required to add the following to `pages/_document.js`:

```
<link rel="stylesheet" href="/_next/static/style.css" />
```

Instead, Next.js will automatically inject the CSS file. In production Next.js will automatically add a content hash to the css url, so that if there are changes you never have to worry about users getting the old version of the file.

This leaves adding CSS imports support to your project to creating a `next.config.js` and adding the `withCSS` plugin:

```js
const withCSS = require('@zeit/next-css')
const existingConfig = {}
module.exports = withCSS(existingConfig)
```

### Dynamic imports

Next.js has had support for dynamic imports through `next/dynamic` since version&nbsp;3.

We were one of the early adopters of dynamic imports in React, and because of this we wrote our own solution to handling `import()`

Because of this Next.js didn't support a few `import()` features webpack has introduced since.

For example for naming and bundling certain files together manually:

```js
import(/* webpackChunkName: 'my-chunk' */ '../lib/my-library')
```

Another example is using `import()` without being wrapped in the `next/dynamic` module.

Starting with Next.js 7 we no longer touch the default `import()` behavior and now all these cases are supported.

The `next/dynamic` usage has **not** been changed:

```js
import dynamic from 'next/dynamic'
const MyComponent = dynamic(import('../components/my-component'))
export default () => {
  return <div>
    <MyComponent />
  </div>
}
```

What this example will do is create a new Javascript file for `my-component` and only load it when `<MyComponent />` is rendered. If it's not rendered the `<script>` tag won't be included in the initial HTML document.

The big change with Next.js 7 is that `next/dynamic` is now powered by a fork of the [`react-loadable`](https://github.com/jamiebuilds/react-loadable) library behind the scenes, allowing for a few new features coming from `react-loadable`:

- timeouts using the `timeout` option on `next/dynamic`
- a loading component delay, using the `delay` option on `next/dynamic`. This allows your `loading` component to wait x time before rendering the loading state, for example if the import is very fast.

## Babel 7

Next.js 6 introduced Babel 7 while it was still in beta. Since then the stable version of Babel 7 has been released, and Next.js 7 now using this version.

For a full list of changes you can refer to Babel's [release notes](http://babeljs.io/blog/2018/08/27/7.0.0http://babeljs.io/blog/2018/08/27/7.0.0)

Some of the main features are:

- Typescript support, for Next.js you can use [`@zeit/next-typescript`](https://github.com/zeit/next-plugins/tree/master/packages/next-typescript)
- Fragment syntax `<>` support
- `babel.config.js` support
- `overrides` property to apply presets/plugins only to a subset of files or directories

If you don't have a custom Babel configuration in your Next.js project there are no breaking changes.

If you do however have a custom Babel configuration you will have to upgrade the respective custom plugins/presets to their latest version

In case you're upgrading from a version below Next.js 6 you can run the excellent [`babel-upgrade`](http://babeljs.io/blog/2018/08/27/7.0.0#babel-upgrade) tool.

In addition to upgrading to Babel 7, the Next.js Babel preset ([`next/babel`](https://github.com/zeit/next.js#customizing-babel-config)) now defaults to setting the `modules` transform to `commonjs` when `NODE_ENV` is set to `test`. 

This was often the only reason for creating a custom `.babelrc` in a Next.js project:

```json
{
  "env": {
    "development": {
      "presets": ["next/babel"]
    },
    "production": {
      "presets": ["next/babel"]
    },
    "test": {
      "presets": [["next/babel", { "preset-env": { "modules": "commonjs" } }]]
    }
  }
}
```

With Next.js 7 this becomes:

```json
{
  "presets": ["next/babel"]
}
```

At this point the `.babelrc` can be removed, as Next.js will then automatically use `next/babel` when there is no Babel configuration.

## Development improvements

One of Next.js's long-term goals is to provide the best possible development experience. Which is why for this release we've been very focused on optimizing development performance and debugging.

### Compilation speed

Thanks to webpack 4, Babel 7 and a lot of optimizations on the Next.js side, Next.js now boots up to 60% faster in development.

<Image src="/static/blog/next-7/bootup.png" width={3636/3} height={1134/3} caption="Booting up Next.js" />

Re-compilation when making changes is up to 40% faster thanks to intermediate caching steps.

<Image src="/static/blog/next-7/making-changes.png" width={3636/3} height={1134/3} caption="Making changes to a page" />

<table>
  <thead>
    <tr>
      <th>&nbsp;</th>
      <th>6.0</th>
      <th>
        <b>7.0</b>
      </th>
      <th>delta</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Bootup time</td>
      <td>
        <b>1947ms</b>
      </td>
      <td>
        <b>835ms</b>
      </td>
      <td>
        <b>57%</b>
        <em>faster</em>
      </td>
    </tr>
    <tr>
      <td>Making changes</td>
      <td>
        <b>304ms</b>
      </td>
      <td>
        <b>178ms</b>
      </td>
      <td>
        <b>42%</b>
        <em>faster</em>
      </td>
    </tr>
  </tbody>
</table>

We've also implemented [webpackbar](https://github.com/nuxt/webpackbar), which shows a real-time status bar when webpack is compiling.

### React Error Overlay

Next.js's error overlay is now powered by [react-error-overlay](https://github.com/facebook/create-react-app/tree/next/packages/react-error-overlay), whenever there is an error thrown in your app Next.js will automatically render the overlay showing the exact line the error happened on with source-maps applied. This means that you can immediately see where the error happened.

<Image src="/static/blog/next-7/error-overlay.png" width={2683/2} height={868/2} caption="The previous overlay left, react-error-overlay right" />

Another feature of react-error-overlay is that it supports opening your code editor by simply clicking the specific code block.

## Smaller initial HTML

As Next.js pre-renders HTML, it wraps pages into a default structure with `<html>`, `<head>`, `<body>` and the Javascript files needed to render the page.

This initial structure was previously around 1.62kB. With Next.js 7 we've optimized the initial HTML structure, it is now 1.5kB, a 7.4% reduction, allowing pages to be downloaded faster.

<table>
  <thead>
    <tr>
      <th>&nbsp;</th>
      <th>6.0</th>
      <th>
        <b>7.0</b>
      </th>
      <th>delta</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Document size (server rendered)</td>
      <td>
        <b>1.62kb</b>
      </td>
      <td>
        <b>1.50kb</b>
      </td>
      <td>
        <b>7.4%</b>
        <em>smaller</em>
      </td>
    </tr>
  </tbody>
</table>

The main ways we've reduced size are:

- The `__next-error` div has been removed
- The inline scripts are now minified, in a future release they will be completely removed
- Compiled away unused `__NEXT_DATA__` properties when they're not used, for example the `nextExport` and `assetPrefix` properties.

## Improved CDN support

In Next.js 5 we introduced `assetPrefix` support, a way to make Next.js automatically load assets from a certain location, usually a CDN. This works great if your CDN supports proxying, you request a url like 
```
https://cdn.example.com/_next/static/<buildid>/pages/index.js
```

the CDN checks if it has the file in it's network, and if it does not it requests the file directly from your deployed instance. 

This is exactly how the [Now CDN](https://zeit.co/cdn) works. 

However, there are some solutions that require pre-uploading a directory directly onto the CDN. The problem in doing this is that Next.js it's url structure did not match the folder structure inside the `.next` folder. For example our earlier example

```
https://cdn.example.com/_next/static/<buildid>/pages/index.js
// mapped to:
.next/page/index.js
```

With Next.js 7 we've changed the directory structure of `.next` to match the url structure:

```
https://cdn.example.com/_next/static/<buildid>/pages/index.js
// mapped to:
.next/static/<buildid>/pages/index.js
```

While we do recommend using the proxying type of CDN, this new structure allows users of a different type of CDN to upload the `.next` directory to their CDN.

## Styled JSX v3

We're excited to introduce styled-jsx 3, the by default included css-in-js solution in Next.js is now ready for React suspense.

One thing that was often unclear was how to style a child component if that component is not part of the current component scope, for example if you included a child component that needed specific styles only when used inside the parent component:

```js
import css from 'styled-jsx/css'

const ChildComponent = () => <div>
  <p>some text</p>
</div>

export default () => <div>
  <ChildComponent />
  <style jsx>{`
    p { color: black }
  `}</style>
<div/>
```

The above code tries to select the `p` tag doesn't work because styled-jsx styles are scoped to the current component, they don't leak into child components. One way to get around this was using the `:global` method, removing the prefix from the `p` tag. However this introduces a new issue, which is that styles do leak across the page.

In styled-jsx 3 this issue has been solved by introducing a new API, `css.resolve`, which will generate the `className` and `<style>` 
 tags (the `styles` property) for the given styled-jsx string:

```js
import css from 'styled-jsx/css'

const ChildComponent = ({className}) => <div className={className}>
  <p>some text</p>
</div>

const { className, styles } = css.resolve`p { color: black }` 

export default () => <div>
  <ChildComponent className={className} />
  {styles}
<div/>
```

This new API allows for transparently passing through custom styling to child components.

Since this is a major release for styled-jsx there is one breaking change that improves bundle sizes if you are using `styles-jsx/css`.
In styled-jsx 2 we would generate a "scoped" and "global" version of external styles, even when only the "scoped" version was used we'd still include the "global" version of those external styles.

With styled-jsx 3 global styles have to be tagged with `css.global` instead of `css`, so that styled-jsx can optimize bundle size.

For all changes please refer to the [release notes](https://github.com/zeit/styled-jsx/releases/tag/v3.0.0).

## React Context between App and Pages

Starting from Next.js 7 we now support the new React context API between `pages/_app.js` and page components.

Previously it was not possible to use React context in between pages on the server side. The reason for this was that webpack keeps an internal module cache instead of using `require.cache`, we've written a custom webpack plugin that changes this behavior to share module instances between pages. In doing so we not only allow usage of the new React context, but also reduce Next.js's memory footprint when sharing code between pages.

<Image src="/static/blog/next-7/memory.png" width={1800/1.5} height={674/1.5} caption="The old vs new memory footprint of a production Next.js app" />

## nextjs.org

Combined with the Next.js 7 release we are launching a completely redesigned [nextjs.org](https://nextjs.org).

### Blog

The blog post you are currently reading is already part of the new blog section on [nextjs.org](https://nextjs.org). This will be the new home for communication related to Next.js, for example new version announcements.

IMAGE HERE

### Get Inspired

As the amount of apps using Next.js is continously growing we needed a way to show all these beautiful apps in one overview. Meet the new [`/showcase`](/showcase) page:

IMAGE HERE

This new showcase allows us to continuously add new apps built with Next.js. 

We invite you to visit [`/showcase`](/showcase) to get inspired, or submit your own site that uses Next.js!

## Community

Ever since it's first release Next.js has been used in everything from fortune 500 companies to personal blogs. We're very excited to see the growth in Next.js adoption.

Currently there are over 12500 publicly indexed domains using Next.js.

We've had over 500 contributors landing at least 1 commit.

On GitHub the project has been starred over 29100 times.

Almost 2200 pull requests were submitted since the first release.

The Next.js community on [spectrum.chat/next-js](https://spectrum.chat/next-js) has almost 1700 people, and we invite you to join the community too.

We've created a [general chat / watercooler](https://spectrum.chat/next-js?thread=610cacbb-b81b-4c77-a071-7774c665e0ee) thread where you can discuss and chat with other Next.js users and the core maintainers.

<style jsx>{`
table {
  margin: 0 auto 30px;
}
table td,
table th {
  padding: 10px 20px;
}
table th {
  font-weight: normal;
  font-size: 12px;
  color: #9b9b9b;
  padding-bottom: 0px;
}
table td:first-child {
  width: 55%;
}
table td {
  font-size: 14px;
  vertical-align: middle;
}
table td:last-child {
  color: #067df7;
}
table td:not(:first-child) {
  text-align: center;
}
table td em {
  font-weight: normal;
  font-size: 10px;
  text-transform: uppercase;
  font-style: normal;
  display: block;
}
`}</style>
